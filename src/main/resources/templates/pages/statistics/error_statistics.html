<html layout:decorate="~{fragments/layout}">
<div layout:fragment="content" class="main-content">
    <!-- card:1 start -->
    <div class="card responsive-content">
        <!-- card body:1 start -->
        <div class="card-body">
            <div class="content-title"><i class="fa-solid fa-chart-simple me-2"></i><span
                    th:text="#{pns.titles.totalerror}"></span></div>
            <!-- card:2 start -->
            <div class="card card-shadow">
                <!-- card body:2 start -->
                <div class="card-body">
                    <div class="card-title"><span class="card-title-bar"></span><span
                            th:text="#{pns.titles.search}"></span></div>
                    <!-- form start -->
                    <form id="searchForm" class="statistics-form" th:action="@{/statistics/error}" method="get">
                        <div class="row">
                            <div class="col-12 search-table">
                                <label for="companyIdSearch" class="col-form-label"><span
                                        th:text="#{pns.labels.company}"></span><b>*</b></label>
                                <select id="companyIdSearch" class="mx-3 form-control" name="companyIdSearch">
                                    <option th:value="*{null}" th:text="#{pns.labels.select}"></option>
                                    <option th:each="company : ${companyList}" th:value="${company.companyId}"
                                        th:text="${company.companyName}"
                                        th:selected="${company.companyId == selectedCompanyId}"></option>
                                </select>
                            </div>
                            <div class="col-12 search-table">
                                <label for="opSearch" class="col-form-label"><span
                                        th:text="#{pns.titles.search}"></span><b>*</b></label>
                                <select id="opSearch" class="ms-3 form-control" name="opSearch">
                                    <option th:value="*{null}" th:text="#{pns.labels.select}"></option>
                                    <option th:value="'stationName'" th:text="#{pns.labels.stationnm}"
                                        th:selected="${selectedOpSearch == 'stationName'}"></option>
                                    <option th:value="'stationId'" th:text="#{pns.labels.stationid}"
                                        th:selected="${selectedOpSearch == 'stationId'}"></option>
                                    <option th:value="'chargerId'" th:text="#{pns.labels.chargerid}"
                                        th:selected="${selectedOpSearch == 'chargerId'}"></option>
                                </select>
                                <input type="text" id="contentSearch" name="contentSearch" class="form-control"
                                    th:value="${selectedContentSearch}" autocomplete="off" />
                            </div>
                            <div class="col-12 search-table">
                                <label for="yearSearch" class="col-form-label"><span
                                        th:text="#{pns.labels.searchyear}"></span><b>*</b></label>
                                <select id="yearSearch" name="yearSearch" class="form-control mx-3">
                                    <option th:each="year : ${yearOption}" th:value="${year.value}"
                                        th:text="${year.text}" th:selected="${year.value == selectedYear}"></option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-outline-grey me-2" id="serachBtn">
                                <i class="bi bi-search me-2"></i><span th:text="#{pns.buttons.search}"></span></button>
                            <button type="button" class="btn btn-outline-grey me-2" id="resetBtn"
                                onclick="replacePage('/statistics/error')">
                                <i class="bi bi-arrow-repeat me-2"></i><span
                                    th:text="#{pns.buttons.reset}"></span></button>
                        </div>

                    </form>
                    <!-- form end -->
                </div>
                <!-- card body:2 end -->
            </div>
            <!-- card:2 end -->
            <!-- card:3 start -->
            <div class="card card-shadow mt-4">
                <!-- card body:3 start -->
                <div class="card-body">
                    <!-- 조회연도 메출통계 -->
                    <div class="card-title">
                        <span class="card-title-bar"></span>
                        <span th:text="|#{pns.titles.errortotofyear}(${errHist.curYear.year})|"></span>
                    </div>
                    <div class="w-100 table-responsive position-relative">
                        <table class="table text-center mt-2 table-bg">
                            <thead>
                                <tr class="table-border-top">
                                    <th scope="col" class="w-20"></th>
                                    <th scope="col"><span th:text="#{chart.labels.fast}"></span></th>
                                    <th scope="col"><span th:text="#{chart.labels.slow}"></span></th>
                                    <th scope="col"><span th:text="#{chart.labels.dispenser}"></span></th>
                                    <th scope="col"><span th:text="#{pns.labels.total}"></span></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th style="background-color: #f5f7f8;"><span
                                            th:text="#{pns.labels.toterrorcnt}"></span></th>
                                    <td th:text="${#numbers.formatInteger(errHist.curYear.fastCount, 0, 'COMMA')}"></td>
                                    <td th:text="${#numbers.formatInteger(errHist.curYear.lowCount, 0, 'COMMA')}"></td>
                                    <td th:text="${#numbers.formatInteger(errHist.curYear.despnCount, 0, 'COMMA')}">
                                    </td>
                                    <td th:text="${#numbers.formatInteger(errHist.curYear.total, 0, 'COMMA')}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="statistics-chart">
                        <canvas id="lineChart"></canvas>
                    </div>
                    <!-- 전연도 데이터 비교 -->
                    <div class="card-title mt-4"><span class="card-title-bar"></span><span
                            th:text="#{pns.labels.comparewithpreviousyear}"></span></div>
                    <div class="statistics-chart">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
                <!-- card body:3 end -->
            </div>
            <!-- card:3 end -->
        </div>
        <!-- card body:1 end -->
    </div>
    <!-- card:1 end -->
    <script th:inline="javascript">
        var errHist = /*[[${errHist != null ? errHist : '{}'}]]*/ {};
        var lineChartData = /*[[${lineChart != null ? lineChart : '{}'}]]*/ {};

        // 리소스 메시지를 JavaScript 변수로 설정
        const monthLabels = {
            january: /*[[#{chart.month.january}]]*/ '1월',
            february: /*[[#{chart.month.february}]]*/ '2월',
            march: /*[[#{chart.month.march}]]*/ '3월',
            april: /*[[#{chart.month.april}]]*/ '4월',
            may: /*[[#{chart.month.may}]]*/ '5월',
            june: /*[[#{chart.month.june}]]*/ '6월',
            july: /*[[#{chart.month.july}]]*/ '7월',
            august: /*[[#{chart.month.august}]]*/ '8월',
            september: /*[[#{chart.month.september}]]*/ '9월',
            october: /*[[#{chart.month.october}]]*/ '10월',
            november: /*[[#{chart.month.november}]]*/ '11월',
            december: /*[[#{chart.month.december}]]*/ '12월'
        };

        const chartLabels = {
            fast: /*[[#{chart.labels.fast}]]*/ '급속',
            slow: /*[[#{chart.labels.slow}]]*/ '완속',
            dispenser: /*[[#{chart.labels.dispenser}]]*/ '디스펜서'
        };

        // line chart
        const speedFastList = lineChartData.speedFastList.map(item => item.total);
        const speedLowList = lineChartData.speedLowList.map(item => item.total);
        const speedDespnList = lineChartData.speedDespnList.map(item => item.total);


        const lineChartConfig = [
            { label: chartLabels.fast, data: speedFastList, color: '#379C6D' },
            { label: chartLabels.slow, data: speedLowList, color: '#E58A10' },
            { label: chartLabels.dispenser, data: speedDespnList, color: '#3366CC' }
        ];

        const lineDatasets = lineChartConfig.map(item => ({
            label: item.label,
            data: item.data,
            borderColor: [item.color],
            backgroundColor: [item.color],
            fill: false
        }));

        // 월별 라벨 생성 (한글일 때는 "월" 추가, 영문일 때는 월 추가 안함)
        const monthArray = [
            monthLabels.january, monthLabels.february, monthLabels.march, monthLabels.april,
            monthLabels.may, monthLabels.june, monthLabels.july, monthLabels.august,
            monthLabels.september, monthLabels.october, monthLabels.november, monthLabels.december
        ];

        const lineData = {
            labels: monthArray,
            datasets: lineDatasets
        }

        var ctx = document.getElementById("lineChart").getContext('2d');
        var lineChart = new Chart(ctx, {
            type: 'line',
            data: lineData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    filler: {
                        propagate: false,
                    }
                },
                interaction: {
                    intersect: false,
                },
                scales: {
                    x: {
                        ticks: {
                            font: {
                                size: 14,
                            }
                        },
                    },
                    y: {
                        min: 0,
                        beginAtZero: true
                    }
                }
            }
        });

        // bar chart
        const barChartConfig = [
            { label: chartLabels.fast, data: [errHist.preYear.fastCount, errHist.curYear.fastCount], color: '#379C6D' },
            { label: chartLabels.slow, data: [errHist.preYear.lowCount, errHist.curYear.lowCount], color: '#E58A10' },
            { label: chartLabels.dispenser, data: [errHist.preYear.despnCount, errHist.curYear.despnCount], color: '#3366CC' }
        ];

        const barDatasets = barChartConfig.map(item => ({
            label: item.label,
            data: item.data,
            backgroundColor: [item.color],
            minBarThickness: 10,
            maxBarThickness: 200
        }));

        const barData = {
            labels: [errHist.preYear.year, errHist.curYear.year],
            datasets: barDatasets
        }

        var ctx = document.getElementById("barChart").getContext('2d');
        var barChart = new Chart(ctx, {
            type: 'bar',
            data: barData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            font: {
                                size: 14,
                            }
                        },
                    },
                    y: {
                        min: 0,
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
    <div th:replace="~{fragments/language-selector :: language-script}"></div>
</div>

</html>